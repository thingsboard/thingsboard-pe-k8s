#
# Copyright Â© 2016-2020 The Thingsboard Authors
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

apiVersion: batch/v1
kind: Job
metadata:
  name: trendz-upgrade
  namespace: thingsboard
spec:
  backoffLimit: 3
  template:
    metadata:
      labels:
        app: trendz-app
    spec:
      restartPolicy: OnFailure
      terminationGracePeriodSeconds: 30
      nodeSelector:
        role: trendz
      containers:
        - name: trendz-app-container
          image: thingsboard/trendz:1.15.0.4
          imagePullPolicy: IfNotPresent
          env:
            - name: UPGRADE_TRENDZ
              value: "true"
#            - name: FROM_VERSION # if not specified - take version from the DB
#              value: "1.14.0"
            - name: JAVA_OPTS
              value: "-Xms256m -Xmx2g -Xss512k -XX:+AlwaysPreTouch"
          envFrom:
            - secretRef:
                name: trendz-secret
            - configMapRef:
                name: tb-cache-config
          volumeMounts:
            - name: trendz-app-config
              mountPath: /trendz-config-files
            - name: trendz-app-logs
              mountPath: /var/log/trendz
            - name: trendz-data
              mountPath: /data
      volumes:
        - name: trendz-app-config
          configMap:
            name: trendz-app-config
            items:
              - key: conf
                path: trendz.conf
              - key: logback.xml
                path: logback.xml
        - name: trendz-app-logs
          emptyDir: {}
        - name: trendz-data
          emptyDir: {}
